<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ product.name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body class="text-light bg-dark">

<div class="container py-5">
  <a href="/" class="btn btn-outline-warning mb-3">← Назад к товарам</a>
  <h1 class="text-warning mb-3">{{ product.name }}</h1>

  <div class="row mb-4">
    {% for photo in product.photos %}
    <div class="col-md-4 mb-2">
      <img src="{{ photo }}" class="img-fluid rounded" alt="{{ product.name }}">
    </div>
    {% endfor %}
  </div>

  <p class="text-secondary">{{ product.long_desc }}</p>
  <h4 class="text-light fw-bold mb-3">{{ product.price_per_100 }} ₽/100г</h4>

  <h5>Выберите вес и количество:</h5>
  <form id="orderForm" class="mb-3">
    <select name="weight" class="form-select mb-3">
      {% for w in product.weights %}
      <option value="{{ w }}">{{ w }} г</option>
      {% endfor %}
    </select>

    <input type="text" name="name" placeholder="Ваше имя" class="form-control mb-2" required>
    <input type="text" name="phone" placeholder="Телефон" class="form-control mb-2" required>
    <textarea name="comment" placeholder="Комментарий (необязательно)" class="form-control mb-2"></textarea>

    <!-- Кол-во упаковок -->
    <div class="mb-2 d-flex align-items-center">
      <label class="form-label me-2 text-warning">Кол-во упаковок</label>
      <button type="button" class="btn btn-sm btn-outline-warning" onclick="changeQuantity(-1)">-</button>
      <input type="number" id="quantityInput" value="1" min="1" class="form-control mx-2" style="width:60px;">
      <button type="button" class="btn btn-sm btn-outline-warning" onclick="changeQuantity(1)">+</button>
    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-success flex-grow-1">Заказать</button>
      <button type="button" class="btn btn-warning flex-grow-1" onclick="addToCart()">Добавить в корзину</button>
    </div>
  </form>
</div>

<script>
document.getElementById('orderForm').onsubmit = async function(e){
  e.preventDefault();
  const form = e.target;
  const data = {
    product_id: {{ product.id }},
    weight: form.weight.value,
    name: form.name.value,
    phone: form.phone.value,
    comment: form.comment.value
  };
  const res = await fetch('/api/order',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(data)
  });
  const json = await res.json();
  if(json.status==='ok'){
    alert('✅ Заказ отправлен!');
    form.reset();
  } else {
    alert('❌ Ошибка при заказе');
  }
};

function changeQuantity(delta){
  const input = document.getElementById('quantityInput');
  let val = parseInt(input.value);
  val += delta;
  if(val < 1) val = 1;
  input.value = val;
}

function addToCart(){
  const product_id = {{ product.id }};
  const weight = parseInt(document.getElementById('orderForm').weight.value);
  const quantity = parseInt(document.getElementById('quantityInput').value);

  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  const existing = cart.find(i => i.product_id === product_id && i.weight === weight);
  if(existing){
    existing.quantity += quantity;
  } else {
    cart.push({product_id, weight, quantity});
  }
  localStorage.setItem('cart', JSON.stringify(cart));
  alert('✅ Товар добавлен в корзину!');
}
</script>

</body>
</html>
